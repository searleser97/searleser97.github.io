!function(e,t,i){"function"==typeof define&&define.amd?define([],i):"object"==typeof module&&module.exports?module.exports=i():e.SocketIOFileUpload=i()}(this,0,function(){return function(e){var t=this;if(!window.File||!window.FileReader)throw Error("Socket.IO File Upload: Browser Not Supported");window.siofu_global||(window.siofu_global={instances:0,downloads:0});var i={},n={},r={},o={},s={};t.fileInputElementId="siofu_input_"+siofu_global.instances++,t.resetFileInputs=!0,t.useText=!1,t.serializedOctets=!1,t.useBuffer=!0,t.chunkSize=102400;var a=function(e,i){var n=document.createEvent("Event");for(var r in n.initEvent(e,!1,!1),i)i.hasOwnProperty(r)&&(n[r]=i[r]);return t.dispatchEvent(n)},u=[],f=function(e,t,i,n){e.addEventListener(t,i,n),u.push(arguments)},l=function(e,t,i,n){e.removeEventListener&&e.removeEventListener(t,i,n)},d=function(i){if(null!==t.maxFileSize&&i.size>t.maxFileSize)a("error",{file:i,message:"Attempt by client to upload file exceeding the maximum file size",code:1});else if(a("start",{file:i})){var s,u=new FileReader,d=siofu_global.downloads++,c=!1,m=t.useText,p=0;u._realReader&&(u=u._realReader),n[d]=i;var v={id:d},h=t.chunkSize;(h>=i.size||0>=h)&&(h=i.size);var g=function(){if(!v.abort){var e=i.slice(p,Math.min(p+h,i.size));m?u.readAsText(e):u.readAsArrayBuffer(e)}},b=function(n){if(!v.abort){var r=Math.min(p+h,i.size);e:{var o=p;n=n.target.result;var f=!1;if(!m)try{var l=new Uint8Array(n);if(t.serializedOctets)n=l;else if(t.useBuffer)n=l.buffer;else{f=!0;var g,b=l.buffer.byteLength,E="";for(g=0;g<b;g+=3)E+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[l[g]>>2],E+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(3&l[g])<<4|l[g+1]>>4],E+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(15&l[g+1])<<2|l[g+2]>>6],E+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[63&l[g+2]];2==b%3?E=E.substring(0,E.length-1)+"=":1==b%3&&(E=E.substring(0,E.length-2)+"=="),n=E}}catch(t){e.emit("siofu_done",{id:d,interrupt:!0});break e}e.emit("siofu_progress",{id:d,size:i.size,start:o,end:r,content:n,base64:f})}a("progress",{file:i,bytesLoaded:r,name:s}),(p+=h)>=i.size&&(e.emit("siofu_done",{id:d}),a("load",{file:i,reader:u,name:s}),c=!0)}};return f(u,"load",b),f(u,"error",function(){e.emit("siofu_done",{id:d,interrupt:!0}),l(u,"load",b)}),f(u,"abort",function(){e.emit("siofu_done",{id:d,interrupt:!0}),l(u,"load",b)}),e.emit("siofu_start",{name:i.name,mtime:i.lastModified,meta:i.meta,size:i.size,encoding:m?"text":"octet",id:d}),o[d]=function(e){s=e,g()},r[d]=function(){c||g()},v}},c=function(e){if(0!==e.length){for(var t=0;t<e.length;t++)e[t].meta||(e[t].meta={});if(a("choose",{files:e}))for(t=0;t<e.length;t++){var i=d(e[t]);s[i.id]=i}}},m=function(e){var i=e.target.files||e.dataTransfer.files;if(e.preventDefault(),c(i),t.resetFileInputs){try{e.target.value=""}catch(e){}if(e.target.value){i=document.createElement("form");var n=e.target.parentNode,r=e.target.nextSibling;i.appendChild(e.target),i.reset(),n.insertBefore(e.target,r)}}};this.submitFiles=function(e){e&&c(e)},this.listenOnSubmit=function(e,t){t.files&&f(e,"click",function(){c(t.files)},!1)},this.listenOnArraySubmit=function(e,t){for(var i in t)this.listenOnSubmit(e,t[i])},this.listenOnInput=function(e){e.files&&f(e,"change",m,!1)},this.listenOnDrop=function(e){f(e,"dragover",function(e){e.preventDefault()},!1),f(e,"drop",m)},this.prompt=function(){var e;(e=document.getElementById(t.fileInputElementId))||((e=document.createElement("input")).setAttribute("type","file"),e.setAttribute("id",t.fileInputElementId),e.style.display="none",document.body.appendChild(e)),f(e,"change",m,!1);var i=document.createEvent("MouseEvents");i.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),e.dispatchEvent(i)},this.destroy=function(){!function(){for(var e=u.length-1;0<=e;e--)l.apply(this,u[e]);u=[]}();var e=document.getElementById(t.fileInputElementId);for(var r in e&&e.parentNode.removeChild(e),s)s.hasOwnProperty(r)&&(s[r].abort=!0);s=o=n=i=null},this.addEventListener=function(e,t){i[e]||(i[e]=[]),i[e].push(t)},this.removeEventListener=function(e,t){if(!i[e])return!1;for(var n=0;n<i[e].length;n++)if(i[e][n]===t)return i[e].splice(n,1),!0;return!1},this.dispatchEvent=function(e){var t=i[e.type];if(!t)return!0;for(var n=!0,r=0;r<t.length;r++)!1===t[r](e)&&(n=!1);return n},f(e,"siofu_chunk",function(e){r[e.id]&&r[e.id]()}),f(e,"siofu_ready",function(e){o[e.id]&&o[e.id](e.name)}),f(e,"siofu_complete",function(e){n[e.id]&&a("complete",{file:n[e.id],detail:e.detail,success:e.success})}),f(e,"siofu_error",function(e){n[e.id]&&(a("error",{file:n[e.id],message:e.message,code:0}),s&&(s[e.id].abort=!0))})}});